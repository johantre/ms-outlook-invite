name: Build User-Specific Solution
run-name: Build Solution for ${{ github.event.inputs.username }}

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username (e.g. johan.tre or test.user; 1st part mail before @)'
        required: true
        type: string
      brand:
        description: 'Brand template to use'
        required: true
        default: 'bmw'
        type: choice
        options:
          - bmw
          - fluvius
          - volvo
          - default

jobs:
  build-user-solution:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate username
        id: validate
        run: |
          USERNAME="${{ github.event.inputs.username }}"

          # Check if username is provided
          if [[ -z "$USERNAME" ]]; then
            echo "::error::Username is required"
            exit 1
          fi

          # Sanitize username for filenames (replace . and @ with _)
          USERNAME_SAFE=$(echo "$USERNAME" | sed 's/[.@]/_/g' | tr '[:upper:]' '[:lower:]')

          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "username_safe=$USERNAME_SAFE" >> $GITHUB_OUTPUT
          echo "âœ“ Username: $USERNAME"
          echo "âœ“ Safe name: $USERNAME_SAFE"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate branded solution
        run: |
          echo "Generating solution with brand: ${{ github.event.inputs.brand }}"
          python3 scripts/generate_solution.py ${{ github.event.inputs.brand }}

      - name: Find latest solution version
        id: find-solution
        run: |
          # Find the solution directory (generated by generate_solution.py)
          SOLUTION_DIR="solution"

          if [[ ! -d "$SOLUTION_DIR" ]]; then
            echo "::error::Solution directory not found"
            exit 1
          fi

          # Get version from solution.xml
          VERSION=$(grep -oP '<Version>\K[^<]+' "$SOLUTION_DIR/solution.xml" | head -1)

          echo "solution_dir=$SOLUTION_DIR" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Solution directory: $SOLUTION_DIR"
          echo "âœ“ Version: $VERSION"

      - name: Generate new workflow GUID
        id: guid
        run: |
          NEW_GUID=$(cat /proc/sys/kernel/random/uuid)
          NEW_GUID_UPPER=$(echo "$NEW_GUID" | tr '[:lower:]' '[:upper:]')
          NEW_GUID_LOWER=$(echo "$NEW_GUID" | tr '[:upper:]' '[:lower:]')

          echo "guid_lower=$NEW_GUID_LOWER" >> $GITHUB_OUTPUT
          echo "guid_upper=$NEW_GUID_UPPER" >> $GITHUB_OUTPUT
          echo "âœ“ New workflow GUID: $NEW_GUID_LOWER"

      - name: Find and store old workflow GUID
        id: old-guid
        run: |
          SOLUTION_DIR="${{ steps.find-solution.outputs.solution_dir }}"

          # Find old GUID from solution.xml
          OLD_GUID_LOWER=$(grep -oP 'id="\{\K[a-f0-9-]+' "$SOLUTION_DIR/solution.xml" | head -1)
          OLD_GUID_UPPER=$(echo "$OLD_GUID_LOWER" | tr '[:lower:]' '[:upper:]')

          # Find old workflow file
          OLD_WORKFLOW_FILE=$(find "$SOLUTION_DIR/Workflows" -name "*.json" | head -1)
          OLD_WORKFLOW_BASENAME=$(basename "$OLD_WORKFLOW_FILE")

          echo "guid_lower=$OLD_GUID_LOWER" >> $GITHUB_OUTPUT
          echo "guid_upper=$OLD_GUID_UPPER" >> $GITHUB_OUTPUT
          echo "workflow_file=$OLD_WORKFLOW_FILE" >> $GITHUB_OUTPUT
          echo "workflow_basename=$OLD_WORKFLOW_BASENAME" >> $GITHUB_OUTPUT
          echo "âœ“ Old workflow GUID: $OLD_GUID_LOWER"
          echo "âœ“ Workflow file: $OLD_WORKFLOW_BASENAME"

      - name: Personalize solution for user
        run: |
          SOLUTION_DIR="${{ steps.find-solution.outputs.solution_dir }}"
          USERNAME="${{ steps.validate.outputs.username }}"
          USERNAME_SAFE="${{ steps.validate.outputs.username_safe }}"
          OLD_GUID_LOWER="${{ steps.old-guid.outputs.guid_lower }}"
          OLD_GUID_UPPER="${{ steps.old-guid.outputs.guid_upper }}"
          NEW_GUID_LOWER="${{ steps.guid.outputs.guid_lower }}"
          NEW_GUID_UPPER="${{ steps.guid.outputs.guid_upper }}"
          OLD_WORKFLOW_FILE="${{ steps.old-guid.outputs.workflow_file }}"

          echo "=== Personalizing solution for $USERNAME ==="

          # 1. Update solution.xml
          # - Replace GUID
          sed -i "s/$OLD_GUID_LOWER/$NEW_GUID_LOWER/gi" "$SOLUTION_DIR/solution.xml"
          # - Update UniqueName
          sed -i "s/<UniqueName>msoutlookinviteoffice365<\/UniqueName>/<UniqueName>msoutlookinviteoffice365_${USERNAME_SAFE}<\/UniqueName>/" "$SOLUTION_DIR/solution.xml"
          # - Update display name
          sed -i "s/description=\"ms-outlook-invite-office365\"/description=\"ms-outlook-invite-office365 (${USERNAME})\"/" "$SOLUTION_DIR/solution.xml"
          echo "âœ“ solution.xml updated"

          # 2. Update customizations.xml
          # - WorkflowId (lowercase)
          sed -i "s/WorkflowId=\"{$OLD_GUID_LOWER}\"/WorkflowId=\"{$NEW_GUID_LOWER}\"/gi" "$SOLUTION_DIR/customizations.xml"
          # - JsonFileName (uppercase)
          sed -i "s/$OLD_GUID_UPPER/$NEW_GUID_UPPER/g" "$SOLUTION_DIR/customizations.xml"
          echo "âœ“ customizations.xml updated"

          # 3. Update connection reference to make it unique per user
          OLD_CONN_REF="jtrbv_sharedoffice365_e66d0"
          NEW_CONN_REF="jtrbv_sharedoffice365_${USERNAME_SAFE}"

          # In customizations.xml (logical name and display name)
          sed -i "s/connectionreferencelogicalname=\"$OLD_CONN_REF\"/connectionreferencelogicalname=\"$NEW_CONN_REF\"/g" "$SOLUTION_DIR/customizations.xml"
          sed -i "s/msoutlookinviteoffice365-e66d0/msoutlookinviteoffice365-${USERNAME_SAFE}/g" "$SOLUTION_DIR/customizations.xml"

          # In workflow JSON (before renaming)
          sed -i "s/$OLD_CONN_REF/$NEW_CONN_REF/g" "$OLD_WORKFLOW_FILE"
          echo "âœ“ Connection reference updated: $NEW_CONN_REF"

          # 4. Rename workflow JSON file
          FLOW_NAME_BASE=$(basename "$OLD_WORKFLOW_FILE" | sed "s/-$OLD_GUID_UPPER\.json//")
          NEW_WORKFLOW_FILE="$SOLUTION_DIR/Workflows/${FLOW_NAME_BASE}-${NEW_GUID_UPPER}.json"
          mv "$OLD_WORKFLOW_FILE" "$NEW_WORKFLOW_FILE"
          echo "âœ“ Workflow file renamed to: $(basename "$NEW_WORKFLOW_FILE")"

      - name: Create Solution Zip
        id: zip
        run: |
          SOLUTION_DIR="${{ steps.find-solution.outputs.solution_dir }}"
          USERNAME_SAFE="${{ steps.validate.outputs.username_safe }}"
          VERSION="${{ steps.find-solution.outputs.version }}"
          VERSION_SAFE=$(echo "$VERSION" | tr '.' '_')
          BRAND="${{ github.event.inputs.brand }}"

          ZIP_NAME="msoutlookinviteoffice365_${USERNAME_SAFE}_${BRAND}_${VERSION_SAFE}.zip"

          cd "$SOLUTION_DIR"
          zip -r "../$ZIP_NAME" . -x "*.DS_Store"
          cd ..

          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "âœ“ Solution package created: $ZIP_NAME"

          # Show zip contents for verification
          echo "=== Contents of $ZIP_NAME ==="
          unzip -l "$ZIP_NAME"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: user-${{ steps.validate.outputs.username_safe }}-${{ github.event.inputs.brand }}
          name: "Latest ${{ github.event.inputs.brand }} Solution build (${{ github.event.inputs.username }})"
          body: |
            ## Power Automate Solution for ${{ github.event.inputs.username }}

            **Brand:** ${{ github.event.inputs.brand }}
            **Version:** ${{ steps.find-solution.outputs.version }}
            **Workflow GUID:** `${{ steps.guid.outputs.guid_lower }}`

            ### Installation
            1. Download `${{ steps.zip.outputs.zip_name }}`
            2. Go to [Power Automate](https://make.powerautomate.com)
            3. Log in as **${{ github.event.inputs.username }}**
            4. Go to **Solutions** â†’ **Import solution**
            5. Upload the downloaded file
            6. Connect your own **Office 365** connection

            ---
            *Generated on ${{ github.event.repository.updated_at }}*
          files: ${{ steps.zip.outputs.zip_name }}
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Solution Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| User | ${{ github.event.inputs.username }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Brand | ${{ github.event.inputs.brand }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.find-solution.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow GUID | \`${{ steps.guid.outputs.guid_lower }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Package | \`${{ steps.zip.outputs.zip_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Go to the [Releases page](/${{ github.repository }}/releases/tag/user-${{ steps.validate.outputs.username_safe }}-${{ github.event.inputs.brand }}) to download the solution." >> $GITHUB_STEP_SUMMARY
